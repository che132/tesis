{
  "hash": "f9fcea193b76ded629157440b93847b9",
  "result": {
    "markdown": "---\ntitle: \"2023_Highland_experiment_design\"\nauthor: Sergio Perez-Limon\nformat: html\neditor_options: \n  chunk_output_type: console\nexecute: \n  freeze: true\n---\n\n\n\n\nHere I use the FieldHub app to design the field evaluation of the CML F2:3 population, for the Highlands we're using a p-rep design (more info: 10.1198/108571106X154443). In total there are going to be 210 genotypes of the HI73 and HI93 populations, 320 from the HI79 and Hermes as a CHECK evaluated in two locations. For this experimental design, 70 genotypes of each biparental population are going to be replicated, and the rest (140, 140 and 250 respectively) are going as single reps. The families are selected based on the phc BLUP value. It is important to note that we're only removing a few families based on this, so there is not an important bias/selection towards the best genotypes, but it might help us to select families that are going to survive. We select the families that are going to be repeated randomly. Check is repeated 50 times. The ecperiment is designed for a 25 columns x 40 rows experiment.\n\nThere is an augmented block design for Ameca, a possible \"no stress\" environment where we can have a baseline to compare the performance of the highland site. Here, the experiment is composed of a 53 block per repetition, and 2 replications, with the same genotypes as the p-rep design. Each genotype is present only once per replication and is not repeated across block either. \n\nLoading libraries\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nlibrary(FielDHub)\nlibrary(googlesheets4)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'googlesheets4' was built under R version 4.2.2\n```\n:::\n\n```{.r .cell-code}\nlibrary(googledrive)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'googledrive'\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nThe following objects are masked from 'package:googlesheets4':\n\n    request_generate, request_make\n```\n:::\n\n```{.r .cell-code}\nlibrary(tidyverse)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n── Attaching packages ─────────────────────────────────────── tidyverse 1.3.2\n──\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ ggplot2 3.4.1      ✔ purrr   1.0.1 \n✔ tibble  3.1.8      ✔ dplyr   1.0.10\n✔ tidyr   1.3.0      ✔ stringr 1.5.0 \n✔ readr   2.1.3      ✔ forcats 0.5.2 \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'ggplot2' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'tidyr' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'readr' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'purrr' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'dplyr' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'stringr' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'forcats' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n── Conflicts ────────────────────────────────────────── tidyverse_conflicts() ──\n✖ dplyr::filter()                 masks stats::filter()\n✖ dplyr::lag()                    masks stats::lag()\n✖ googledrive::request_generate() masks googlesheets4::request_generate()\n✖ googledrive::request_make()     masks googlesheets4::request_make()\n```\n:::\n\n```{.r .cell-code}\nlibrary(lme4)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'lme4' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nLoading required package: Matrix\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nWarning: package 'Matrix' was built under R version 4.2.2\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\nAttaching package: 'Matrix'\n\nThe following objects are masked from 'package:tidyr':\n\n    expand, pack, unpack\n```\n:::\n\n```{.r .cell-code}\ngs4_auth(\"checo.spl@gmail.com\")\n```\n:::\n\n\n\n\nImport available genotypes and genotype information\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# raw data for genotypes\ndata_url <- \"https://docs.google.com/spreadsheets/d/14yHP2kqQZQ-wp0IdiUgeUeQIeqorQed3-m-xcwFu_Ko/edit#gid=723581705\"\n\ngenotypes_data_raw <- \n  data_url %>%\n  as_id() %>%\n  range_read(sheet = \"Genetic Stocks\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nAuto-refreshing stale OAuth token.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ Reading from \"CML457_459_Populations\".\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ Range ''Genetic Stocks''.\n```\n:::\n\n```{.r .cell-code}\nfamilies_url <- \"https://docs.google.com/spreadsheets/d/1Mix1vFbJkeLhC3psHaOxxJscgPXsiizt-unjrE1Arbs/edit#gid=497667827\"\n\nseed_availability_url <- \"https://docs.google.com/spreadsheets/d/14yHP2kqQZQ-wp0IdiUgeUeQIeqorQed3-m-xcwFu_Ko/edit#gid=723581705\"\n\n# Import raw data for families\nfamilies_data_raw <- families_url %>%\n  as_id %>%\n  range_read(ss =., sheet = \"UNISEM21A\", skip = 1)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ Reading from \"21_NCS_PSU_LANGEBIO_FIELDS\".\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ Range ''UNISEM21A'!2:10000000'.\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\nNew names:\n• `` -> `...16`\n• `` -> `...18`\n```\n:::\n\n```{.r .cell-code}\nseed_available <- seed_availability_url %>%\n  as_id() %>%\n  range_read(ss =., sheet = \"Genetic Stocks\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ Reading from \"CML457_459_Populations\".\n✔ Range ''Genetic Stocks''.\n```\n:::\n\n```{.r .cell-code}\npacking_seed_info_url <- \"https://docs.google.com/spreadsheets/d/14yHP2kqQZQ-wp0IdiUgeUeQIeqorQed3-m-xcwFu_Ko/edit#gid=2014961217\"\n\n# packing seed info\n\npacking_seed_info <- \n  packing_seed_info_url %>%\n  as_id() %>%\n  range_read(ss =., sheet = \"seed_packing_2022\")\n```\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ Reading from \"CML457_459_Populations\".\n✔ Range ''seed_packing_2022''.\n```\n:::\n\n```{.r .cell-code}\npacking_seed_info_unique <- \n  packing_seed_info %>%\n  select(familia, F2_Parent, sobre_UNISEM) %>%\n  unique() %>%\n  rename(`Female genotype` = familia, `Female parent` = sobre_UNISEM)\n```\n:::\n\n\n\n\nHighland site p-rep design\n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\n# Genotypes available for planting\n\navailable_genos <- \n  genotypes_data_raw %>%\n  select(family = Family_ID, pop = Population_ID, use = `Use_23 (798)`) %>%\n  filter(use == 1)\n\n# select families based on the best BLUP values\ncml_pops_raw_data <- \n  data_url %>%\n  as_id() %>%\n  range_read(\"22_Highland_Raw_data_tidy\") %>%\n  mutate(phc = as.double(phc)) \n```\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ Reading from \"CML457_459_Populations\".\n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n✔ Range ''22_Highland_Raw_data_tidy''.\n```\n:::\n\n```{.r .cell-code}\ncml_phc_example <-\n  cml_pops_raw_data %>%\n  select(location, family, phc, nblock) %>%\n  mutate(across(c(location, family), ~ as_factor(.))) %>%\n  mutate(phc = ifelse(phc > 2 | phc == 0, NA_real_, phc)) %>%\n  filter(family != \"HERMES\")\n\nset.seed(100)\nphc_BLUP_example <- \n  lmer(\n    phc ~ location + (1|family) + (1|location:nblock), data = cml_phc_example\n    ) %>%\n  ranef() %>%\n  .$family %>%\n  as_tibble(rownames = \"family\") %>%\n  rename(BLUP = `(Intercept)`)\n\n# Best families available based on the BLUP value\nprospect_families <- \n  phc_BLUP_example %>%\n  semi_join(available_genos) %>%\n  mutate(pop = gsub(\"-\\\\d+$\", \"\", family)) %>%\n  arrange(pop, desc(BLUP)) %>%\n  group_by(pop) %>%\n  mutate(id = row_number()) %>%\n  filter(\n    (pop == \"HI73\" & id %in% c(1:210)) | \n      (pop == \"HI93\" & id %in% c(1:210)) |\n      (pop == \"HI79\" & id %in% c(1:320))\n  ) %>%\n  ungroup() %>%\n  rename(phc_BLUP = BLUP)\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining, by = \"family\"\n```\n:::\n\n```{.r .cell-code}\n# p-rep eperimental design using FieldHub\n\nhighland_2023_prep_design <- \n  partially_replicated(\n    nrows = 40, \n    ncols = 25,\n    repGens = c(530, 210, 1),\n    repUnits = c(1, 2, 50),\n    planter = \"serpentine\",\n    l = 2,\n    seed = 100,\n    locationNames = c(\"site1\", \"site2\")\n    )\n```\n\n::: {.cell-output .cell-output-stdout}\n```\nWarning message: \n Since plotNumber was missing, it was set up to default value of:  1001 2001 \n \n```\n:::\n\n::: {.cell-output .cell-output-stderr}\n```\n\n```\n:::\n\n```{.r .cell-code}\n# Extracting the fieldbook from the experimental design\nhigh23_fieldbook <- \n  highland_2023_prep_design$fieldBook %>%\n  as_tibble() %>%\n  rename_with(~tolower(.))\n\n# Selecting rep families by random and randomizing families within each pop\nset.seed(100)\nhigh_exp_data <-\n  prospect_families %>%\n  group_by(pop) %>%\n  slice_sample(prop = 1) %>%\n  mutate(id2 = row_number()) %>%\n  ungroup() %>%\n  select(family, pop, id2) %>%\n  add_row(family = \"CHECK\", id2 = NA, .before = 1) %>%\n  mutate(\n    rep = case_when(\n      is.na(id2) ~ 50,\n      id2 %in% c(1:70) ~ 2,\n      T ~ 1\n    )) %>%\n  arrange(desc(rep), pop, id2) %>%\n  mutate(id = row_number())\n\ntreatment_family <- \n  high23_fieldbook %>%\n  count(location, treatment) %>%\n  mutate(id = gsub(\"G\", \"\", treatment) %>% as.integer()) %>%\n  rename(rep = n) %>%\n  arrange(id) %>%\n  left_join(high_exp_data) %>%\n  select(treatment, family, pop) %>%\n  distinct() %>%\n  mutate(pop = ifelse(is.na(pop), \"CHECK\", pop))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining, by = c(\"rep\", \"id\")\n```\n:::\n\n```{.r .cell-code}\nhigh23_fieldbook_family <- \n  high23_fieldbook %>%\n  left_join(treatment_family) \n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining, by = \"treatment\"\n```\n:::\n\n```{.r .cell-code}\nhigh23_fieldbook_family\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 2,000 × 12\n      id expt  location year   plot   row column checks entry treatment family  \n   <int> <chr> <chr>    <chr> <dbl> <int>  <int> <chr>  <dbl> <chr>     <chr>   \n 1     1 Expt1 SITE1    2023   1001     1      1 186      186 G186      HI93-271\n 2     2 Expt1 SITE1    2023   1002     1      2 0        574 G574      HI79-370\n 3     3 Expt1 SITE1    2023   1003     1      3 0        218 G218      HI73-028\n 4     4 Expt1 SITE1    2023   1004     1      4 0        508 G508      HI79-280\n 5     5 Expt1 SITE1    2023   1005     1      5 0        567 G567      HI79-306\n 6     6 Expt1 SITE1    2023   1006     1      6 115      115 G115      HI79-286\n 7     7 Expt1 SITE1    2023   1007     1      7 0        444 G444      HI79-321\n 8     8 Expt1 SITE1    2023   1008     1      8 0        384 G384      HI79-191\n 9     9 Expt1 SITE1    2023   1009     1      9 1          1 G1        CHECK   \n10    10 Expt1 SITE1    2023   1010     1     10 0        482 G482      HI79-104\n# … with 1,990 more rows, and 1 more variable: pop <chr>\n```\n:::\n\n```{.r .cell-code}\nhigh23_fieldbook_family %>%\n  ggplot(data =., aes(x = row, y = column)) +\n  geom_tile(\n    aes(fill = pop),\n    color = \"black\") +\n  facet_grid(. ~ location)\n```\n\n::: {.cell-output-display}\n![](CML-2023-03-12-23_Highland_Ameca_Experimental_Design_files/figure-docx/unnamed-chunk-3-1.png)\n:::\n\n```{.r .cell-code}\ndata_spreadsheet <-\n  high23_fieldbook_family %>%\n  select(\n    `CML23-` = plot, Description = pop, `Female genotype` = family, \n    row_design = row, column_design = column, checks) %>%\n  mutate(\n    `Origin (Package)` = \"LANGEBIO\",\n    `Packed?` = \" \",\n    `Who/What` = \"AL/JL\",\n    `Male parent` = \"x sib\",\n    `Male genotype` = \"x sib\",\n    `Number/Selection` = \"14K\",\n    rep = case_when(\n      checks == 0 ~ 1,\n      Description == \"CHECK\" ~ 50,\n      T ~ 2\n    )\n  ) %>%\n  left_join(packing_seed_info_unique) %>%\n  select(\n    `CML23-`, `Origin (Package)`:`Who/What`, Description, `Female parent`, \n    `Male parent`, `Female genotype`,  `Male genotype`, `Number/Selection`,\n    row_design, column_design, rep\n    ) %>%\n  mutate(across(contains(\"Female\"), ~ ifelse(is.na(.), \"HERMES\", .)))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining, by = \"Female genotype\"\n```\n:::\n\n```{.r .cell-code}\nwrite_csv(data_spreadsheet, \"23_highland_experiment_spreadsheet.csv\")\n```\n:::\n\n\n\n\nAmeca augmented complete block design \n\n\n\n\n::: {.cell}\n\n```{.r .cell-code}\nprospect_families %>%\n  count(pop) %>%\n  mutate(prop = n/sum(n)) %>%\n  mutate(a = prop*24)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 4\n  pop       n  prop     a\n  <chr> <int> <dbl> <dbl>\n1 HI73    210 0.284  6.81\n2 HI79    320 0.432 10.4 \n3 HI93    210 0.284  6.81\n```\n:::\n\n```{.r .cell-code}\nprospect_families %>% dim %>% .[[1]]\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n[1] 740\n```\n:::\n\n```{.r .cell-code}\nAmeca_RCBD <- RCBD_augmented(\n  lines = prospect_families %>% dim %>% .[[1]],\n  planter = \"serpentine\",\n  checks = 1,\n  b = 53, \n  repsExpt = 2, \n  l = 1,\n  random = TRUE,\n  locationNames = c(\"Ameca\"),\n  seed = 100, \n  )\n\n# 57, 53, 50, 47, 44\n\nAmeca_fieldbook <- Ameca_RCBD$fieldBook %>%\n  as_tibble() %>%\n  rename_with( ~ tolower(.))\n\nAmeca_fieldbook %>%\n  filter(treatment != \"CH1\") %>%\n  count(block) %>%\n  mutate(nn = n/2) %>%\n  count(nn)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1 × 2\n     nn     n\n  <dbl> <int>\n1    14    53\n```\n:::\n\n```{.r .cell-code}\nprospect_families %>%\n  count(pop) %>% \n  mutate(prop = n/sum(n)) %>%\n  mutate(a = prop*14)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 3 × 4\n  pop       n  prop     a\n  <chr> <int> <dbl> <dbl>\n1 HI73    210 0.284  3.97\n2 HI79    320 0.432  6.05\n3 HI93    210 0.284  3.97\n```\n:::\n\n```{.r .cell-code}\n# Per block: 4 HI73/HI93; 6 HI79\n\nset.seed(100)\nAmeca_fieldbook_pops <- \n  Ameca_fieldbook %>%\n  mutate(rep = ifelse(id < 796, 1, 2)) %>%\n  group_by(rep, block) %>%\n  mutate(rowid = row_number()) %>%\n  slice_sample(prop = 1) %>%\n  mutate(\n    type = ifelse(treatment == \"CH1\", \"check\", \"family\"),\n    type = factor(type, levels = c(\"check\", \"family\"))\n    ) %>%\n  ungroup() %>%\n  arrange(rep, block, type) %>%\n  mutate(what = rep(c(\"HERMES\", rep(\"HI73\", 4), rep(\"HI79\", 6), rep(\"HI93\", 4)), 106)) %>%\n  filter(treatment != \"Filler\")\n\nAmeca_fieldbook_pops %>%\n  count(rep, what)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 8 × 3\n    rep what       n\n  <dbl> <chr>  <int>\n1     1 HERMES    53\n2     1 HI73     211\n3     1 HI79     317\n4     1 HI93     212\n5     2 HERMES    53\n6     2 HI73     211\n7     2 HI79     318\n8     2 HI93     211\n```\n:::\n\n```{.r .cell-code}\n# Need 420 HI73/HI93; 640 HI79\n\nset.seed(100)\nextra_family_replacement <- \n  Ameca_fieldbook_pops %>%\n  filter(what %in% c(\"HI93\", \"HI73\")) %>%\n  group_by(rep, what) %>%\n  slice_sample(n = 3) %>%\n  filter(\n    (rep == 1 & what == \"HI73\" & row_number() == 1) |\n      (rep == 1 & what == \"HI93\" & row_number() %in% c(1:2)) |\n      (rep == 2 & what == \"HI73\" & row_number() %in% c(1)) |\n      (rep == 2 & what == \"HI93\" & row_number() %in% c(1))\n  ) %>%\n  mutate(what = \"HI79\")\n\n\nset.seed(100)\nAmeca_fieldbook_pops_family <- Ameca_fieldbook_pops %>%\n  anti_join(extra_family_replacement, by = c(\"rep\", \"plot\")) %>%\n  bind_rows(extra_family_replacement) %>%\n  arrange(rep, what) %>%\n  group_by(rep, what) %>%\n  slice_sample(prop = 1) %>%\n  mutate(id2 = row_number()) %>%\n  left_join(prospect_families %>% select(-phc_BLUP), by = c(\"what\" = \"pop\", \"id2\" = \"id\")) %>%\n  mutate(family = ifelse(what == \"HERMES\", \"HERMES\", family)) %>%\n  ungroup()\n\nAmeca_fieldbook_pops_family %>%\n  arrange(id) %>%\n  select(id, plot:block, rep, treatment, pop = what, family)\n```\n\n::: {.cell-output .cell-output-stdout}\n```\n# A tibble: 1,586 × 10\n      id  plot   row column checks block   rep treatment pop    family  \n   <int> <dbl> <int>  <int> <chr>  <dbl> <dbl> <chr>     <chr>  <chr>   \n 1     1   101     1      1 0          1     1 G658      HI93   HI93-179\n 2     2   102     1      2 1          1     1 CH1       HERMES HERMES  \n 3     3   103     1      3 0          1     1 G205      HI73   HI73-092\n 4     4   104     1      4 0          1     1 G133      HI93   HI93-233\n 5     5   105     1      5 0          1     1 G641      HI93   HI93-108\n 6     6   106     1      6 0          1     1 G321      HI73   HI73-137\n 7     7   107     1      7 0          1     1 G418      HI73   HI73-220\n 8     8   108     1      8 0          1     1 G44       HI79   HI79-162\n 9     9   109     1      9 0          1     1 G636      HI79   HI79-268\n10    10   110     1     10 0          1     1 G391      HI73   HI73-248\n# … with 1,576 more rows\n```\n:::\n\n```{.r .cell-code}\nAmeca_fieldbook_pops_family %>%\n  select(id, plot:block, rep, treatment, pop = what, family) %>%\n  ggplot(data =., aes(x = column, y = row, fill = pop)) +\n  geom_tile(color = \"black\")\n```\n\n::: {.cell-output-display}\n![](CML-2023-03-12-23_Highland_Ameca_Experimental_Design_files/figure-docx/unnamed-chunk-4-1.png)\n:::\n\n```{.r .cell-code}\nAmeca_data_spreadsheet <-\n  Ameca_fieldbook_pops_family %>%\n  arrange(id) %>%\n  mutate(`CML23-` = id + 4000) %>%\n  select(\n    `CML23-`, Description = what, `Female genotype` = family, \n    row_design = row, column_design = column, checks, rep, block) %>%\n  mutate(\n    `Origin (Package)` = \"LANGEBIO\",\n    `Packed?` = \" \",\n    `Who/What` = \"AL/JL\",\n    `Male parent` = \"x sib\",\n    `Male genotype` = \"x sib\",\n    `Number/Selection` = \"14K\"\n    ) %>%\n  left_join(packing_seed_info_unique) %>%\n  select(\n    `CML23-`, `Origin (Package)`:`Who/What`, Description, `Female parent`, \n    `Male parent`, `Female genotype`,  `Male genotype`, `Number/Selection`,\n    row_design, column_design, rep, block\n    ) %>%\n  mutate(across(contains(\"Female\"), ~ ifelse(is.na(.), \"HERMES\", .)))\n```\n\n::: {.cell-output .cell-output-stderr}\n```\nJoining, by = \"Female genotype\"\n```\n:::\n\n```{.r .cell-code}\nwrite_csv(Ameca_data_spreadsheet, \"Ameca_data_spreadsheet.csv\")\n```\n:::\n",
    "supporting": [
      "CML-2023-03-12-23_Highland_Ameca_Experimental_Design_files\\figure-docx"
    ],
    "filters": [
      "rmarkdown/pagebreak.lua"
    ],
    "includes": {},
    "engineDependencies": {
      "knitr": [
        "{\"type\":\"list\",\"attributes\":{},\"value\":[]}"
      ]
    },
    "preserve": null,
    "postProcess": false
  }
}